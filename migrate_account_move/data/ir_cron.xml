<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record forcecreate="True" id="ir_cron_invoie_to_move" model="ir.cron">
        <field name="name">Migrate: Invoice Fields to Move models</field>
        <field name="model_id" ref="account.model_account_invoice"/>
        <field name="state">code</field>
        <field name="code">
l10n_cl_dte_status = {
    'draft': 'not_sent',
    'NoEnviado': 'not_sent',
    'EnCola': 'not_sent',
    'Enviado': 'ask_for_status',
    'Aceptado': 'accepted',
    'Rechazado': 'rejected',
    'Reparo': 'objected',
    'Proceso': 'accepted',
    'Anulado': 'cancelled'
}

# for record in record:
for record in env['account.invoice'].search([], limit=5000, offset=0).filtered(lambda invoice: invoice.move_id):
  move_id = record.move_id
  line_ids = move_id.line_ids
  move_id.write({
      'partner_shipping_id': record.partner_shipping_id.id,
      'invoice_payment_term_id': record.payment_term_id.id,
      'fiscal_position_id': record.fiscal_position_id.id,
      'invoice_date': record.date_invoice,
      'invoice_date_due': record.date_due,
      'invoice_user_id': record.user_id.id,
      'team_id': record.team_id.id,
      'invoice_id': record.id,
      'move_type': record.type,
      'l10n_cl_dte_status': l10n_cl_dte_status.get(record.sii_result, False)
    })
  for invoice_line_id in record.invoice_line_ids:
    line_filter_id = line_ids.filtered(lambda l: l.account_id.id == invoice_line_id.account_id.id and abs(l.balance) == invoice_line_id.price_subtotal)
    if len(line_filter_id) > 1:
      line_filter_id = line_filter_id.filtered(lambda l: l.name == invoice_line_id.name and not l.invoice_line_id)
      if len(line_filter_id) > 1:
        line_filter_id = line_filter_id[0]
    if line_filter_id:
      line_filter_id.write({
        'price_unit': invoice_line_id.price_unit,
        'discount': invoice_line_id.discount,
        'invoice_line_tax_ids': [(6, 0, invoice_line_id.invoice_line_tax_ids.ids)],
        'exclude_from_invoice_tab': False,
        'invoice_line_id': invoice_line_id.id,
        'sale_line_ids': [(6, 0, invoice_line_id.sale_line_ids.ids)]
      })
        </field>
        <field eval="False" name="active"/>
        <field name="user_id" ref="base.user_root"/>
        <field eval="False" name="doall"/>
    </record>
</odoo>
